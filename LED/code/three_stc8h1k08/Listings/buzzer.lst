C51 COMPILER V9.59.0.0   BUZZER                                                            02/15/2023 10:30:41 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE BUZZER
OBJECT MODULE PLACED IN .\Objects\buzzer.obj
COMPILER INVOKED BY: C:\Keil_C51\C51\BIN\C51.EXE src\buzzer.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\src;.\Driver\inc;.\
                    -Driver\src) DEBUG PRINT(.\Listings\buzzer.lst) TABS(2) OBJECT(.\Objects\buzzer.obj)

line level    source

   1          #include "buzzer.h"
   2          #include "global.h"
   3          #include "STC8xxxx.h"
   4          
   5          bit buzzerEnableFlag;
   6          
   7          u8 buzzer_timer;
   8          u8 buzzer_config_time;
   9          
  10          static void to_PWM_value(u8 pwm_val);
  11          static void pwm0_init(void);
  12          void buzzer_time_set(u8 time);
  13          
  14          void buzzer_init(void)
  15          {
  16   1          buzzerEnableFlag =1;
  17   1          pwm0_init();
  18   1          to_PWM_value(0x7f);  //蜂鸣器驱动脉冲频率2000
  19   1          buzzer_time_set(2);  //250ms 
  20   1      }
  21          
  22          void buzzer_run(void)
  23          {
  24   1          if(buzzerEnableFlag)
  25   1          {
  26   2              buzzerEnableFlag = 0;
  27   2              buzzer_timer =0;
  28   2              to_PWM_value(0x7f);  //蜂鸣器驱动脉冲频率2000
  29   2              PCA_PWM0 = 0;
  30   2              CR = 1; //启动 PCA 计时器
  31   2          }
  32   1          else
  33   1          {
  34   2              if(buzzer_timer > buzzer_config_time)  //计时单位125ms
  35   2              {
  36   3                   buzzer_timer = 0;
  37   3                   CR = 0; //停止 PCA 计时器 
  38   3                   PCA_PWM0 &= 0xC0;
  39   3                   CCAP0H = 0x00;  //PWM 固定输出高电平       
  40   3              }
  41   2          }
  42   1      
  43   1      }
  44          
  45          void PWM0_Isr() interrupt PWM0_VECTOR
  46          {
  47   1          if (PWMCFG01 & 0x08)
  48   1          {
  49   2              PWMCFG01 &= ~0x08; //清中断标志
  50   2           
  51   2          }
  52   1      }
  53          void buzzer_time_set(u8 time)
  54          {
C51 COMPILER V9.59.0.0   BUZZER                                                            02/15/2023 10:30:41 PAGE 2   

  55   1          buzzer_config_time = time;
  56   1      }
  57          static void pwm0_init(void)
  58          {
  59   1      
  60   1        P_SW1 &= ~0x18;  //pwm波形从p1.1端口输出
  61   1        CCON = 0x00;
  62   1        CMOD = 0x80; //PCA 时钟为系统时钟12/1 0x08; //PCA 时钟为系统时钟
  63   1        CL = 0x00;
  64   1        CH = 0x00;
  65   1        
  66   1        CCAPM0 = 0x42; //PCA 模块 0 为 PWM 工作模式
  67   1        PCA_PWM0 = 0;//0x70/0x80 //PCA 模块 0 输出 8/7/6 位 PWM   6  10.5us  7  21.2us  8 42.5us  0.5ms
  68   1        CCAP0L = 0x7f; //比较值 PWM 占空比为 50%[(40H-20H)/40H]
  69   1        CCAP0H = 0x7f;  //重载值 
  70   1        /*
  71   1        CCAPM1 = 0x42; //PCA 模块 1 为 PWM 工作模式
  72   1        PCA_PWM1 = 0x40; //PCA 模块 1 输出 7 位 PWM
  73   1        CCAP1L = 0x20; //PWM 占空比为 75%[(80H-20H)/80H]
  74   1        CCAP1H = 0x20;
  75   1        
  76   1        CCAPM2 = 0x42; //PCA 模块 2 为 PWM 工作模式
  77   1        PCA_PWM2 = 0x00; //PCA 模块 2 输出 8 位 PWM
  78   1        CCAP2L = 0x20; //PWM 占空比为 87.5%[(100H-20H)/100H]
  79   1        CCAP2H = 0x20;
  80   1        */
  81   1        //CR = 1; //启动 PCA 计时器
  82   1        
  83   1          
  84   1      }
  85          
  86          //*************************************
  87          // 函数名称：TOPWMVALUE
  88          // 函数功能：设置PWM占空比
  89          // 入口参数：占空比值
  90          // 出口参数：无
  91          //***************************************
  92          void to_PWM_value(u8 pwm_val) 
  93          {
  94   1           
  95   1          CCAP0L = pwm_val;//pwm_percentage;
  96   1          CCAP0H = pwm_val;//pwm_percentage;
  97   1          
  98   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    101    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
